# ICU Vital Sign Forecasting

**Forecasting ICU Patient Vital-Sign Deterioration Using Hybrid Statistical and Deep Learning Models**

---

## Overview

This project develops and compares multiple time-series forecasting models to predict ICU patient vital signs 6 hours into the future using 6 hours of historical data. The goal is to enable early detection of patient deterioration, providing clinicians with actionable lead time for intervention.

The project utilizes the **MIMIC-III Clinical Database** and implements statistical, machine learning, and deep learning approaches, including a novel hybrid ARIMA-LSTM ensemble model.

---

## Table of Contents

- [Dataset](#dataset)
- [Project Structure](#project-structure)
- [Pipeline Overview](#pipeline-overview)
- [Models Implemented](#models-implemented)
- [Results](#results)
- [Installation](#installation)
- [Usage](#usage)
- [Output Files](#output-files)
- [Requirements](#requirements)

---

## Dataset

**Source:** MIMIC-III Clinical Database v1.4

**Target Vital Signs:**
| Vital Sign | Unit | Description |
|------------|------|-------------|
| HR | bpm | Heart Rate |
| SpO2 | % | Oxygen Saturation |
| SBP | mmHg | Systolic Blood Pressure |
| DBP | mmHg | Diastolic Blood Pressure |
| MBP | mmHg | Mean Blood Pressure |
| RR | /min | Respiratory Rate |
| Temp | °C | Temperature |

**Sample Statistics:**
- ICU Stays: 2,000 (sampled from 61,532 total)
- Minimum Length of Stay: 24 hours
- Total Vital Sign Records: 1,663,885
- Hospital Mortality Rate in Sample: 11.35%

---

## Project Structure

```
├── ICU_Vital_Sign_Forecasting_EDA_1.ipynb      # Exploratory Data Analysis
├── ICU_Vital_Sign_Preprocessing_2.ipynb         # Data Preprocessing & Feature Engineering
├── ICU_Vital_Sign_Modeling_3.ipynb              # Model Building & Evaluation
├── ICU_Analysis_4.ipynb                         # Advanced Analysis (SHAP, Clinical Interpretation)
├── README.md
│
├── processed/                                    # Generated by Notebook 2
│   ├── X_train.npy, y_train.npy
│   ├── X_val.npy, y_val.npy
│   ├── X_test.npy, y_test.npy
│   ├── vital_scaler.pkl
│   ├── vitals_processed_full.csv
│   ├── config.json
│   ├── feature_names.csv
│   └── vital_names.csv
│
├── models/                                       # Generated by Notebook 3
│   ├── lstm_model.h5
│   ├── transformer_model.h5
│   ├── model_comparison.csv
│   └── predictions_*.npy
│
└── figures/                                      # Generated by Notebook 4
    ├── shap_summary_hr.png
    ├── shap_bar_hr.png
    └── hybrid_weight_sensitivity.png
```

---

## Pipeline Overview

### Notebook 1: Exploratory Data Analysis

**Purpose:** Extract and explore vital sign data from MIMIC-III

**Operations:**
1. Load core MIMIC-III tables (D_ITEMS, ICUSTAYS, PATIENTS, ADMISSIONS)
2. Identify vital sign ITEMIDs from CHARTEVENTS
3. Sample 2,000 ICU stays with LOS ≥ 24 hours
4. Extract vital signs using chunk-based processing
5. Analyze vital sign distributions and temporal patterns
6. Create mortality and deterioration outcome labels

**Outputs:**
- `sample_icustays_2000.csv`
- `vitals_sample_2000.csv`
- `icu_outcomes_2000.csv`

---

### Notebook 2: Data Preprocessing & Feature Engineering

**Purpose:** Clean, transform, and prepare data for modeling

**Operations:**

1. **Data Cleaning**
   - Remove physiologically implausible values using defined ranges
   - Convert Fahrenheit to Celsius for temperature unification

2. **Temporal Resampling**
   - Aggregate irregular measurements to hourly means
   - Create complete hourly timeline for each ICU stay

3. **Missing Value Imputation**
   - Forward fill (up to 4 hours)
   - Backward fill (up to 4 hours)
   - Linear interpolation (up to 6 hours)
   - Population median for remaining gaps

4. **Normalization**
   - Z-score standardization using StandardScaler

5. **Feature Engineering**
   - Rolling statistics (mean, std, min, max over 6 hours)
   - Rate of change (1-hour and 3-hour differences)
   - Lag features (1h, 3h, 6h)
   - Time-based features (hours_since_admission, time_normalized, is_first_24h)

6. **Deterioration Labels**
   - mortality_24h: Death within 24 hours
   - mortality_48h: Death within 48 hours
   - vital_deterioration: 2+ vitals in critical range (|z| > 2)

7. **Sequence Creation**
   - Sliding window: 6-hour input → 6-hour forecast
   - Train/Validation/Test split: 70/15/15 by ICU stay

**Data Shapes:**
- X: (n_samples, 6, 26) — 6 timesteps × 26 features
- y: (n_samples, 6, 7) — 6 timesteps × 7 vitals

**Dataset Sizes:**
| Split | Sequences | ICU Stays |
|-------|-----------|-----------|
| Train | 203,407 | 1,381 |
| Validation | 35,151 | 296 |
| Test | 46,924 | 296 |

---

### Notebook 3: Model Building & Evaluation

**Purpose:** Implement and compare forecasting models

**Models:**

#### 1. ARIMA (Statistical Baseline)
- Order: (2, 1, 2)
- Univariate forecasting per vital sign
- Evaluated on 500 random test samples

#### 2. XGBoost (Machine Learning)
- 42 separate models (6 forecast hours × 7 vitals)
- Flattened input: (samples, 180) — 6 timesteps × 30 features
- Parameters: n_estimators=100, max_depth=6, learning_rate=0.1

#### 3. LSTM (Deep Learning)
- Architecture: 2-layer LSTM with 64 units each
- Dropout: 0.2
- Output: Dense layers with reshape to (6, 7)
- Optimizer: Adam (lr=0.001)
- Training: 50 epochs with early stopping (patience=10)

#### 4. Transformer (Deep Learning)
- Architecture: 2 TransformerBlocks
- Embedding dimension: 64
- Attention heads: 4
- Feed-forward dimension: 128
- Learnable positional encoding
- Global average pooling
- Total parameters: 187,690

#### 5. Hybrid ARIMA-LSTM
- Approach: ARIMA captures linear trends, LSTM predicts residuals
- Final prediction = ARIMA prediction + LSTM residual prediction
- Weights: 0.3 × ARIMA + 0.7 × LSTM

#### 6. Hybrid-Ensemble
- Optimized per-vital weights between LSTM and ARIMA
- Grid search for optimal weight combinations

**Evaluation Metrics:**
- RMSE (Root Mean Squared Error)
- MAE (Mean Absolute Error)
- MAPE (Mean Absolute Percentage Error)
- R² Score

---

### Notebook 4: Advanced Analysis

**Purpose:** Model interpretability and clinical evaluation

**Operations:**

1. **SHAP Feature Importance**
   - TreeExplainer for XGBoost
   - Feature importance by category (raw, rolling mean, rolling std, diff)
   - Feature importance by vital sign

2. **Hyperparameter Tuning**
   - Grid search for optimal hybrid ensemble weights
   - Per-vital weight optimization

3. **Clinical Interpretation**
   - Convert normalized RMSE to clinical units
   - Assess clinical acceptability of prediction errors

---

## Models Implemented

| Model | Type | Description |
|-------|------|-------------|
| ARIMA | Statistical | AutoRegressive Integrated Moving Average |
| XGBoost | Machine Learning | Gradient Boosting Regressor |
| LSTM | Deep Learning | Long Short-Term Memory Network |
| Transformer | Deep Learning | Self-Attention Based Architecture |
| Hybrid ARIMA-LSTM | Ensemble | Residual-based combination |
| Hybrid-Ensemble | Ensemble | Optimized weighted combination |

---

## Results

### Overall Model Performance

| Model | Mean RMSE | Mean MAE | Mean R² |
|-------|-----------|----------|---------|
| XGBoost | 0.5631 | 0.2824 | 0.5947 |
| Hybrid-Ensemble | 0.5723 | 0.2948 | 0.5821 |
| LSTM | 0.5778 | 0.3008 | 0.5757 |
| Transformer | 0.5834 | 0.3046 | 0.5689 |
| Hybrid ARIMA-LSTM | 0.6511 | 0.3225 | 0.4633 |
| ARIMA | 0.9180 | 0.4040 | 0.0638 |

### Per-Vital Performance (XGBoost - Best Model)

| Vital | RMSE | MAE | R² |
|-------|------|-----|-----|
| HR | 0.2806 | 0.2059 | 0.9291 |
| SpO2 | 0.6781 | 0.3412 | 0.3935 |
| SBP | 0.5770 | 0.3280 | 0.5607 |
| DBP | 0.6126 | 0.3330 | 0.5311 |
| MBP | 0.6251 | 0.3393 | 0.4899 |
| RR | 0.6518 | 0.3576 | 0.5748 |
| Temp | 0.5164 | 0.0722 | 0.6835 |

### Clinical Interpretation

Approximate prediction errors in clinical units (based on XGBoost):

| Vital | Approximate Error | Clinical Significance |
|-------|-------------------|----------------------|
| HR | ~8.5 bpm | Acceptable for trend monitoring |
| SpO2 | ~1.7% | Within tolerance for desaturation detection |
| SBP | ~11.4 mmHg | Allows detection of hypo/hypertension events |
| DBP | ~6.8 mmHg | Suitable for blood pressure monitoring |
| MBP | ~8.5 mmHg | Acceptable for perfusion assessment |
| RR | ~2.8 /min | Good for respiratory trend detection |
| Temp | ~0.4°C | Enables fever detection |

---

## Installation

1. Clone or download the repository

2. Install required packages:
```bash
pip install pandas numpy matplotlib seaborn scipy scikit-learn
pip install tensorflow xgboost statsmodels shap
```

3. Download MIMIC-III Clinical Database (requires credentialed access from PhysioNet)

4. Update file paths in each notebook to point to your MIMIC-III installation

---

## Usage

Execute notebooks in order:

```
1. ICU_Vital_Sign_Forecasting_EDA_1.ipynb
   └── Generates: vitals_sample_2000.csv, sample_icustays_2000.csv

2. ICU_Vital_Sign_Preprocessing_2.ipynb
   └── Generates: X_train.npy, y_train.npy, vital_scaler.pkl, etc.

3. ICU_Vital_Sign_Modeling_3.ipynb
   └── Generates: Trained models, predictions, comparison tables

4. ICU_Analysis_4.ipynb
   └── Generates: SHAP plots, clinical interpretation
```

**Important:** Update the `BASE_PATH` variable in each notebook to your MIMIC-III data directory.

---

## Output Files

### From Preprocessing (processed/)

| File | Description |
|------|-------------|
| X_train.npy | Training input sequences (203,407 × 6 × 26) |
| y_train.npy | Training target sequences (203,407 × 6 × 7) |
| X_val.npy | Validation input sequences (35,151 × 6 × 26) |
| y_val.npy | Validation target sequences (35,151 × 6 × 7) |
| X_test.npy | Test input sequences (46,924 × 6 × 26) |
| y_test.npy | Test target sequences (46,924 × 6 × 7) |
| vital_scaler.pkl | StandardScaler for inverse transformation |
| vitals_processed_full.csv | Full processed dataset for ARIMA |
| config.json | Configuration parameters |
| feature_names.csv | List of 26 feature names |
| vital_names.csv | List of 7 vital sign names |
| normalization_params.csv | Mean, std, min, max per vital |
| meta_train.csv | Training metadata (ICUSTAY_ID, start_hour) |
| meta_val.csv | Validation metadata |
| meta_test.csv | Test metadata |

### From Modeling (models/)

| File | Description |
|------|-------------|
| model_comparison.csv | Performance metrics for all models |
| vital_comparison.csv | Per-vital RMSE comparison |
| predictions_*.npy | Model predictions on test set |

### From Analysis (figures/)

| File | Description |
|------|-------------|
| shap_summary_hr.png | SHAP feature importance summary |
| shap_bar_hr.png | SHAP bar plot (mean importance) |
| shap_by_category.png | Importance grouped by feature type |
| shap_by_vital.png | Importance grouped by vital sign |
| hybrid_weight_sensitivity.png | Ensemble weight sensitivity analysis |
| per_vital_weights_bar.png | Optimal weights per vital |
| per_vital_optimal_weights.csv | Optimal ensemble weights table |

---

## Requirements

```
pandas>=1.4.0
numpy>=1.21.0
matplotlib>=3.5.0
seaborn>=0.11.0
scipy>=1.7.0
scikit-learn>=1.0.0
tensorflow>=2.10.0
xgboost>=1.6.0
statsmodels>=0.13.0
shap>=0.41.0
```

---

## Key Findings

1. **XGBoost achieved the best overall performance** with Mean RMSE of 0.5631 and R² of 0.5947

2. **Heart Rate (HR) is the most predictable vital sign** across all models (R² > 0.90)

3. **SpO2 and Temperature are the most challenging** to predict accurately

4. **Recent raw vital values and 6-hour rolling means** are the most important features (SHAP analysis)

5. **Deep learning models (LSTM, Transformer) outperform ARIMA** but not XGBoost for this task

6. **Hybrid ensemble approaches** provide competitive performance with interpretability benefits

7. **Prediction errors are within clinically acceptable ranges** for early warning system deployment

---

## Physiological Ranges Used

| Vital | Min | Max |
|-------|-----|-----|
| HR | 20 | 300 bpm |
| SpO2 | 50 | 100 % |
| SBP | 40 | 300 mmHg |
| DBP | 20 | 200 mmHg |
| MBP | 30 | 250 mmHg |
| RR | 4 | 60 /min |
| Temp (C) | 30 | 45 °C |
| Temp (F) | 86 | 113 °F |

---

## Acknowledgments

This project uses the MIMIC-III Clinical Database:

> Johnson, A. E. W., Pollard, T. J., Shen, L., Lehman, L. H., Feng, M., Ghassemi, M., Moody, B., Szolovits, P., Celi, L. A., & Mark, R. G. (2016). MIMIC-III, a freely accessible critical care database. Scientific Data, 3, 160035.

---

## License

This project is for educational and research purposes. MIMIC-III data usage requires completion of the CITI training course and signing of a data use agreement with PhysioNet.
